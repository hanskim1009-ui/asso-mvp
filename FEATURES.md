# ASSO MVP - 구현된 기능

## ✅ 완료된 기능

### 1. Case 관리
- [x] 사건 생성 (기본 정보 + 사용자 컨텍스트)
- [x] 사건 목록 조회
- [x] 사건 상세 페이지
- [x] 사건 수정
- [x] 사건 삭제

### 2. 문서 관리
- [x] PDF 업로드 (다중)
- [x] **HWP(한글) 업로드**: .hwp 파일 선택 시 `hwp.js`로 텍스트 추출, OCR/PDF 경로와 동일한 저장·청킹 플로우. `POST /api/extract-hwp-text`, `lib/hwpExtract.js`.
- [x] Upstage OCR 자동 실행 (출력 형식: 텍스트(기본) / HTML)
- [x] **OCR 좌표 포함 (coordinates)** 옵션: 체크 시 Upstage에 coordinates: true 전달 (텍스트 레이어용)
- [x] 문서 목록 표시
- [x] 문서 삭제 (Soft Delete)
- [x] PDF 보기 (새 탭)

### 3. AI 분석
- [x] Gemini 2.5 Flash 통합
- [x] 사용자 컨텍스트 반영
  - 대리인 구분 (피고인/피해자)
  - 사건 배경, 주장, 중점 사항
- [x] 다중 문서 통합 분석
- [x] **선택한 문서 분석 시 증거기록 분류·분석 참고**: 선택한 문서에 해당하는 분류·섹션별 분석만 참고하여 통합 분석 품질 향상
- [x] **문서 분석 페이지 번호**: 원문에 _pages.json 있으면 `[문서 N - k페이지]` 표기로 전달 → 페이지 참조 정확도 향상
- [x] 분석 결과 구조화
  - 사건 요약
  - 쟁점
  - 타임라인 (페이지 번호 포함)
  - 증거 목록 (페이지 번호 포함)
  - 유리한 정황
  - 모순점

### 4. 분석 결과 관리
- [x] 분석 히스토리
- [x] 분석 제목 자동 생성 ("파일명 외 2개")
- [x] 분석 제목 수정
- [x] 분석 결과 삭제 (Soft Delete)
- [x] 분석 선택 및 표시
- [x] **분석 결과 메모/코멘트**
  - 타임라인 이벤트별 메모 (선택)
  - 증거 항목별 메모 (선택)
  - 보기 모드에서 메모 표시
- [x] **분석 결과 비교**
  - 2개 분석 선택 후 나란히 비교 (요약, 쟁점, 타임라인, 증거, 유리한 정황, 모순점)
  - **차이 강조** 토글: 시간순(created_at) 기준 삭제됨/추가됨/수정됨
  - 요약 단어 단위 diff, 리스트·타임라인·증거 뱃지 표시
- [x] **AI 수정 시 새 분석으로 저장**
  - 수정 전 분석은 유지, 수정 결과는 "[AI 수정] 제목"으로 새 항목 추가
  - 수정 전/후 분석 비교 가능

### 5. 편집 기능
- [x] 타임라인 직접 편집
  - 이벤트 추가/수정/삭제
  - 이벤트별 메모 (note)
- [x] 증거 목록 편집
  - 증거 추가/수정/삭제
  - 증거별 메모 (note)
- [x] AI 수정 요청
  - 자연어로 수정 요청
  - 기존 분석 기반 수정 → **결과는 새 분석으로 저장**
- [x] 저장 기능

### 6. 원문 키워드 검색
- [x] 사건 소속 문서 청크에서 키워드 검색
- [x] 검색 결과 클릭 시 PDF + 원문 인라인 표시 (해당 페이지로 이동)
- [x] 원문 텍스트에 검색어 하이라이트
- [x] **PDF 실제 페이지 번호 사용** (Upstage elements 기반, 새 업로드 문서부터 적용)

### 7. 증거기록 분류·분석
- [x] 문서별 "증거기록 분류" 버튼 (텍스트 기반 AI 분류)
- [x] 페이지별 증거 유형 분류 (증거목록, 진술조서, 계좌내역, 사진 증거 등)
- [x] 연속 같은 유형 → 증거 섹션 그룹핑
- [x] OCR 불가 섹션: 사용자 설명·태그 입력
- [x] 증거 섹션별 개별 분석 (유형별 프롬프트)
- [x] 분류 결과 수정, 분석 결과 표시
- [x] **Vision으로 설명 생성** (사진 증거·OCR 불가 섹션)
  - 해당 PDF 페이지를 이미지로 Gemini Vision에 전달 → 객관적 설명 생성 후 `vision_description` 저장
  - 개별 분석 시 원문 + Vision 설명 + 메모를 함께 참고
  - UI: 확장 시 Vision 설명 블록 표시, "Vision으로 설명 생성" / "Vision 재생성" 버튼
- [x] **증거기록 분류 삭제**: 문서별 「분류 삭제」 버튼 → 해당 문서의 분류·분석 데이터 전부 삭제 (삭제 후 재분류 가능)

### 8. UI/UX
- [x] Timeline 시각화
- [x] Toast 알림
- [x] Dialog 확인
- [x] Loading 상태
- [x] 페이지 번호 표시
- [x] 분석 비교 뷰 (차이 강조 on/off)
- [x] **분석 상세 PDF 뷰어**: 타임라인·증거의 p.N 클릭 시 오른쪽 고정 패널에 해당 PDF 페이지 표시 (페이지 이동·확대/축소)

### 9. 분석 리포트 다운로드
- [x] **분석 리포트 PDF 다운로드**: 분석 결과(요약, 쟁점, 타임라인, 증거, 유리한 정황, 모순점, 엔티티)를 PDF 파일로 내보내기. 사건 상세 > 분석 상세에서 「리포트 PDF 다운로드」 버튼. `@react-pdf/renderer` + NotoSansKR 한글 폰트.
- [x] **AI 프롬프트 다운로드**: 분석 데이터가 삽입된 서면 작성용 프롬프트 세트 제공. 「프롬프트 다운로드 ▾」 드롭다운 → 의견서 작성용, 변론요지서 작성용, 보석·구속적부심 청구서용, 탄핵자료 정리용 중 선택 시 .txt 다운로드. `lib/analysisPromptTemplates.js` (템플릿 + 데이터 삽입, AI 호출 없음).
- [x] 사용자가 다운받은 PDF·프롬프트를 자신의 AI(ChatGPT, Claude 등)에 붙여 넣어 서면 작성 가능

### 10. 페이지 번호 검증 (후처리)
- [x] **페이지 검증** 버튼: 분석 결과의 페이지 참조가 원문 범위·내용과 맞는지 검증 (AI 호출 없음).
- [x] 분석에 사용된 문서의 `_pages.json`을 불러와 ① **inRange**: 해당 문서 페이지 범위(1~maxPage) 내인지, ② **contentMatch**: 해당 페이지 원문에 항목 키워드가 포함되는지 휴리스틱 검사.
- [x] 타임라인·증거 목록에 ✅(확인됨) / ⚠️(미확인) 배지 표시. 분석 상세 헤더에 요약(예: "타임라인 5/5, 증거 3/4") 표시.
- [x] `lib/analysisPageVerification.js` (`verifyAnalysisPages`, `verificationSummary`).

## ⏳ 보류/미구현

### 원문 키워드 검색 — 텍스트 레이어 오버레이
- OCR 좌표(coordinates)로 PDF 위에 텍스트 겹치기 시도 후 revert. 재시도 예정.

### 인앱 의견서 생성 (보류, 2026-02-22)
- **이유**: 고비용 모델(Claude Opus 4.5 등) 필요. 월 1~3만 원 가격대에서 사용자 반복 실행 시 수익성 불가.
- **대안**: "분석 PDF + 프롬프트 다운로드" 방식 채택. 수익 구조 안정 후 프리미엄 티어로 재검토.
- 관련 코드: `app/api/opinion/`, `lib/opinionPrompts.js` (보존, 비활성 상태)

### 판례 DB 연동 (보류, 2026-02-22)
- **이유**: 자체 판례 수집 비현실적 (엘박스 405만건, 대법원 AI 플랫폼 등 선점). 분석 파이프라인 가치에 집중.
- **향후**: 엘박스 API 또는 외부 판례 검색 서비스 연동 검토.

### Few-shot Learning
- 이유: Supabase RLS 미설정 시 접근 불가
- 상태: RLS 설정 시 재활성화 가능 (`docs/SUPABASE_FEW_SHOT_SETUP.md`)

### 문서/참고자료 업로드 — 혼합 PDF 페이지 단위 처리 (나중에 구현)
- **내용**: 텍스트 레이어와 이미지가 섞인 PDF에서, 페이지마다 텍스트 레이어가 충분하면 pdfjs로만 추출하고, 비어 있거나 짧은 페이지만 이미지로 렌더 후 OCR. 이미지 페이지만 Upstage 등 OCR API에 보내 비용 절감.
- **적용 대상**: 문서 업로드(사건 페이지), 참고자료 ingest.
- **고도화(선택)**: 같은 페이지 내 영역별 텍스트/이미지 구분 후 이미지 영역만 OCR (레이아웃 분석 필요).
