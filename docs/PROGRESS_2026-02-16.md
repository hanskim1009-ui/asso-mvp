# 진행 내역 (2026-02-16)

## 1. 증거기록 분류·분석 기능 구현

### 개요
한국 형사사건 증거기록(열람등사본) PDF를 업로드하면, 각 증거를 자동 분류하고 증거별로 분석하며, OCR 불가 페이지는 사용자가 설명을 입력할 수 있는 기능.

### 설계
- **설계서**: `docs/EVIDENCE_RECORD_DESIGN.md`
- **방식**: 텍스트 기반 (Upstage OCR → footer 또는 elements 기반 페이지 분리 → Gemini 텍스트 모델로 분류)
- **DB**: `docs/EVIDENCE_TABLES_SETUP.md` — `page_classifications`, `evidence_sections` 테이블

### 구현 내용

| 구분 | 내용 |
|------|------|
| **DB** | `page_classifications`, `evidence_sections` 테이블 + RLS (Supabase SQL 실행 필요) |
| **lib/database.js** | savePageClassifications, getPageClassifications, saveEvidenceSections, getEvidenceSections, getEvidenceSection, updateEvidenceSection, clearEvidenceData |
| **API** | POST /api/classify-evidence, GET/PUT /api/evidence-sections/[id], GET /api/cases/[id]/evidence-sections, POST /api/evidence-sections/[id]/analyze |
| **UI** | EvidenceClassifier 컴포넌트 — 문서별 분류 버튼, 분류 결과 테이블, 섹션 확장(수정/분석/분석 결과 보기), OCR 불가 설명 입력 |

### 증거 유형 (section_type)
- evidence_list, complainant_statement, suspect_statement, witness_statement, financial_record, photo_evidence, medical_report, investigation_report, digital_evidence, contract_document, other

### 버그 수정 (증거기록 분류 관련)
- **페이지 번호 "19."**: AI 응답 page 필드를 `parseInt(String(item.page).replace(/\D/g, ''))` 로 정수 변환
- **중복 페이지 upsert 에러**: savePageClassifications에서 Map으로 중복 페이지 제거 후 저장

---

## 2. 원문 키워드 검색 — PDF 페이지 번호 정확도

### 문제
- 31페이지 PDF(전체 기록의 일부) 업로드 시, 원문 검색에서 "p.193" 등 **전체 기록의 페이지 번호**가 표시됨
- footer 태그 안 숫자는 원본 기록 페이지(193), 실제 PDF 페이지는 5

### 해결: Upstage elements 기반 페이지 사용

| 파일 | 변경 |
|------|------|
| **app/api/ocr/route.js** | 응답의 `elements` 배열에서 페이지별 텍스트 추출 → `{timestamp}_pages.json` 저장, 응답에 `pageTextsUrl` 추가 |
| **app/api/chunk-pdf/route.js** | `pageTextsUrl` 있으면 `splitIntoChunksByPageJson` 사용 (PDF 페이지 1,2,3... 기준), 없으면 footer 순서 fallback |
| **app/api/classify-evidence/route.js** | `_pages.json` 있으면 우선 사용, 없으면 footer 방식 |
| **app/cases/[id]/page.js** | 업로드 시 chunk-pdf에 `pageTextsUrl` 전달 |

### fallback
- Upstage API에 `elements`가 없거나 페이지 정보가 없으면, 기존 footer 태그 **등장 순서**를 PDF 페이지로 사용 (1, 2, 3...)

---

## 3. 기타 (이전 세션 반영)

- **PDF 페이지 내 하이라이트**: iframe 방식으로 롤백 (PDF.js 오버레이 방식은 좌표 이슈로 제거)
- **NEXT_STEPS.md**: "원문 키워드 검색 시 PDF 페이지 내 하이라이트"를 최종 목표로 추가

---

## 4. 문서/설정 요약

| 문서 | 용도 |
|------|------|
| docs/EVIDENCE_RECORD_DESIGN.md | 증거기록 분류·분석 상세 설계 (텍스트 기반, API, UI, 구현 단계) |
| docs/EVIDENCE_TABLES_SETUP.md | Supabase 테이블 생성 SQL + RLS |
| docs/SUPABASE_FEW_SHOT_SETUP.md | good_analysis_examples 테이블 및 RLS (기존) |

---

## 5. 사용 시 유의사항

- **Supabase**: `docs/EVIDENCE_TABLES_SETUP.md`의 SQL을 실행해야 증거기록 분류 기능 사용 가능
- **페이지 번호**: 새로 업로드하는 문서부터 Upstage elements 기반 정확한 PDF 페이지 적용; 기존 문서는 재업로드 시 반영
