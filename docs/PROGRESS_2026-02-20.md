# 진행 내역 (2026-02-20)

## 1. 선택한 문서 분석 시 증거기록 분류·분석 참고

### 개요
「선택한 문서 분석」 실행 시, 선택한 문서에 해당하는 증거기록 분류 결과와 섹션별 분석 결과를 AI에 함께 전달하여 통합 분석 품질·일관성을 높임.

### 동작
- **참고 범위**: 선택한 문서와 연결된 증거 섹션만 포함 (선택하지 않은 문서의 분류는 제외).
- **분류만 있는 섹션**: 제목·유형·페이지·발췌만 참고.
- **분석 완료된 섹션**: 분류 + `analysis_result` JSON까지 참고.
- **API**: `POST /api/analyze-integrated` 요청 body에 `evidenceContext: { sections: [...] }` 추가.

### 구현
| 구분 | 내용 |
|------|------|
| **app/cases/[id]/page.js** | 선택 문서에 해당하는 evidenceSections 필터 → evidenceContext로 전달 |
| **app/api/analyze-integrated/route.js** | evidenceContext 수신, 프롬프트에 증거기록 분류·분석 참고 블록 삽입 (섹션당 발췌 2500자 제한) |

---

## 2. 문서 분석 페이지 번호 정확도 (증거기록 분류와 동일 방식)

### 문제
통합 분석 결과에서 실제 페이지 수를 초과한 페이지(예: 33페이지 문서에 34, 35, 36)가 참조되는 현상. 증거기록 분류는 페이지가 정확했음.

### 원인
- 증거기록 분류: `_pages.json` 또는 footer 파싱으로 **페이지별로 구분된 데이터** 사용.
- 문서 분석: **원문 txt 통째로**만 전달해, 모델이 페이지를 추론하다 오류 발생.

### 해결
- **선택한 문서 분석** 시에도 증거기록 분류와 동일하게 `_pages.json` 사용.
- `_pages.json`이 있으면 원문을 `[문서 N - k페이지]\n...` 형태로 포맷하여 전달.
- API 프롬프트: 「원문에 [문서 N - k페이지] 표기가 있으면 page: k 사용, 원문에 없는 페이지 번호 사용 금지」 명시.

### 구현
| 구분 | 내용 |
|------|------|
| **app/cases/[id]/page.js** | 문서별 pageTextsUrl 유도 → fetch 후 페이지별 텍스트로 조합, 없으면 기존처럼 txtUrl만 사용 |
| **app/api/analyze-integrated/route.js** | 페이지 번호 지시 문구 수정 (표기 우선, footer 보조) |

---

## 3. 문서 업로드 — 텍스트(기본) 선택 시 업로드 실패 수정

### 문제
PDF 선택 후 「텍스트 (기본)」 선택하고 업로드 시작 시, 파일이 저장되지 않고 OCR·청킹도 진행되지 않음.

### 원인
프론트에서 `ocrJson.success && ocrJson.text`일 때만 문서 저장. OCR 응답에 `text`가 비어 있거나 다른 키로 오는 경우 조건 미충족.

### 해결
저장 조건을 `ocrJson.success && ocrJson.txtFileUrl`로 변경. API는 성공 시 항상 `txtFileUrl`을 반환하므로, 텍스트 모드에서도 문서 저장·청킹 정상 진행.

| 파일 | 변경 |
|------|------|
| **app/cases/[id]/page.js** | `if (ocrJson.success && ocrJson.text)` → `if (ocrJson.success && ocrJson.txtFileUrl)` |

---

## 4. 증거기록 분류 삭제 기능

### 개요
문서별로 증거기록 분류·분석 결과를 삭제할 수 있는 기능. 삭제 후에도 해당 문서에 대해 다시 분류 가능.

### 구현
| 구분 | 내용 |
|------|------|
| **API** | `DELETE /api/documents/[id]/evidence-classification` — 해당 문서의 evidence_sections, page_classifications 전부 삭제 (clearEvidenceData 사용) |
| **app/api/documents/[id]/evidence-classification/route.js** | 신규 추가 |
| **app/components/EvidenceClassifier.js** | 문서 헤더에 「분류 삭제」 버튼 추가 (분류가 있을 때만 표시), 확인 후 DELETE 호출 → onSectionsChange |

---

## 5. 요약

| 항목 | 내용 |
|------|------|
| 통합 분석 | 선택 문서에 해당하는 증거기록 분류·분석 참고 |
| 페이지 번호 | 문서 분석도 _pages.json 기반 페이지 표기 사용 |
| 업로드 | 텍스트(기본) 선택 시에도 txtFileUrl 기준 저장으로 정상 동작 |
| 증거기록 분류 | 문서별 분류 삭제 API 및 UI 추가 |
