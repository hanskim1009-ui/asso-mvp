# 진행 내역 (2026-02-20)

## 1. 선택한 문서 분석 시 증거기록 분류·분석 참고

### 개요
「선택한 문서 분석」 실행 시, 선택한 문서에 해당하는 증거기록 분류 결과와 섹션별 분석 결과를 AI에 함께 전달하여 통합 분석 품질·일관성을 높임.

### 동작
- **참고 범위**: 선택한 문서와 연결된 증거 섹션만 포함 (선택하지 않은 문서의 분류는 제외).
- **분류만 있는 섹션**: 제목·유형·페이지·발췌만 참고.
- **분석 완료된 섹션**: 분류 + `analysis_result` JSON까지 참고.
- **API**: `POST /api/analyze-integrated` 요청 body에 `evidenceContext: { sections: [...] }` 추가.

### 구현
| 구분 | 내용 |
|------|------|
| **app/cases/[id]/page.js** | 선택 문서에 해당하는 evidenceSections 필터 → evidenceContext로 전달 |
| **app/api/analyze-integrated/route.js** | evidenceContext 수신, 프롬프트에 증거기록 분류·분석 참고 블록 삽입 (섹션당 발췌 2500자 제한) |

---

## 2. 문서 분석 페이지 번호 정확도 (증거기록 분류와 동일 방식)

### 문제
통합 분석 결과에서 실제 페이지 수를 초과한 페이지(예: 33페이지 문서에 34, 35, 36)가 참조되는 현상. 증거기록 분류는 페이지가 정확했음.

### 원인
- 증거기록 분류: `_pages.json` 또는 footer 파싱으로 **페이지별로 구분된 데이터** 사용.
- 문서 분석: **원문 txt 통째로**만 전달해, 모델이 페이지를 추론하다 오류 발생.

### 해결
- **선택한 문서 분석** 시에도 증거기록 분류와 동일하게 `_pages.json` 사용.
- `_pages.json`이 있으면 원문을 `[문서 N - k페이지]\n...` 형태로 포맷하여 전달.
- API 프롬프트: 「원문에 [문서 N - k페이지] 표기가 있으면 page: k 사용, 원문에 없는 페이지 번호 사용 금지」 명시.

### 구현
| 구분 | 내용 |
|------|------|
| **app/cases/[id]/page.js** | 문서별 pageTextsUrl 유도 → fetch 후 페이지별 텍스트로 조합, 없으면 기존처럼 txtUrl만 사용 |
| **app/api/analyze-integrated/route.js** | 페이지 번호 지시 문구 수정 (표기 우선, footer 보조) |

---

## 3. 문서 업로드 — 텍스트(기본) 선택 시 업로드 실패 수정

### 문제
PDF 선택 후 「텍스트 (기본)」 선택하고 업로드 시작 시, 파일이 저장되지 않고 OCR·청킹도 진행되지 않음.

### 원인
프론트에서 `ocrJson.success && ocrJson.text`일 때만 문서 저장. OCR 응답에 `text`가 비어 있거나 다른 키로 오는 경우 조건 미충족.

### 해결
저장 조건을 `ocrJson.success && ocrJson.txtFileUrl`로 변경. API는 성공 시 항상 `txtFileUrl`을 반환하므로, 텍스트 모드에서도 문서 저장·청킹 정상 진행.

| 파일 | 변경 |
|------|------|
| **app/cases/[id]/page.js** | `if (ocrJson.success && ocrJson.text)` → `if (ocrJson.success && ocrJson.txtFileUrl)` |

---

## 4. 증거기록 분류 삭제 기능

### 개요
문서별로 증거기록 분류·분석 결과를 삭제할 수 있는 기능. 삭제 후에도 해당 문서에 대해 다시 분류 가능.

### 구현
| 구분 | 내용 |
|------|------|
| **API** | `DELETE /api/documents/[id]/evidence-classification` — 해당 문서의 evidence_sections, page_classifications 전부 삭제 (clearEvidenceData 사용) |
| **app/api/documents/[id]/evidence-classification/route.js** | 신규 추가 |
| **app/components/EvidenceClassifier.js** | 문서 헤더에 「분류 삭제」 버튼 추가 (분류가 있을 때만 표시), 확인 후 DELETE 호출 → onSectionsChange |

---

## 5. 분석 상세 — 페이지 참조 클릭 시 PDF 뷰어

### 개요
분석 상세의 타임라인·증거 목록에서 페이지 참조(p.N)를 클릭하면, **분석 상세 칸 밖** 오른쪽에 전용 PDF 뷰어가 고정되어 해당 페이지가 표시됨.

### 동작
- **위치**: 화면 오른쪽 고정 패널 (`fixed right-0`), 분석 상세 카드와 분리되어 가독성 향상.
- **페이지 이동**: 상단바에 이전/다음 버튼, 현재 페이지 표시(첫 번째 스크린샷 스타일), 확대/축소(50%~200%).
- **타임라인**: `Timeline` 컴포넌트에 `onPageClick(page, source)` 전달 → p.N 클릭 시 해당 문서·페이지로 뷰어 열림.
- **증거 목록**: 증거의 p.N 클릭 시에도 동일하게 뷰어 열림 (문서는 분석의 첫 문서 사용).

### 구현
| 구분 | 내용 |
|------|------|
| **app/cases/[id]/page.js** | analysisPdfViewer 상태, openAnalysisPdf(), 고정 패널 UI(넓이 min(560px,55vw)), 페이지·확대 버튼 |
| **app/components/Timeline.js** | onPageClick prop 추가, p.N을 버튼으로 렌더 후 클릭 시 onPageClick(page, source) 호출 |

---

## 6. OCR — 좌표 포함(coordinates) 옵션

### 개요
문서 업로드 시 Upstage OCR 호출에 **좌표 포함** 선택지를 추가. 이미지 PDF 위에 OCR 텍스트를 겹치는 기능(텍스트 레이어)을 위한 기반.

### 동작
- **UI**: OCR 출력 형식(텍스트/HTML) 옆에 「좌표 포함 (coordinates)」 체크박스 추가.
- **API**: 체크 시 Upstage 요청 FormData에 `coordinates: 'true'` 추가.
- **로그**: 응답 elements가 있으면 첫 element의 키와 `coordinates`/`bounding_box`/`bbox` 값을 서버 로그에 출력 (확인용).
- **Upstage 응답**: coordinates: true 시 각 element에 `coordinates` 배열 포함 (4점 {x,y}, 0~1 정규화). 비용은 페이지당 동일하다는 정책(공개 문서 기준).

### 구현
| 구분 | 내용 |
|------|------|
| **app/cases/[id]/page.js** | ocrIncludeCoordinates 상태, 체크박스 UI, formData에 includeCoordinates 전달 |
| **app/api/ocr/route.js** | includeCoordinates 읽기, Upstage body에 coordinates 추가, elements 구조 로그 |

---

## 7. 텍스트 레이어 오버레이 (시도 후 revert)

### 시도 내용
원문 키워드 검색 결과 클릭 시 나타나는 PDF 뷰어에, OCR elements 좌표를 이용해 텍스트 레이어를 겹쳐 표시.

### 구현했던 항목 (모두 되돌림)
- OCR에서 좌표 있을 때 `_elements.json` 저장 및 elementsUrl 반환
- getChunkById에서 documents에 txt_url, txt_file_name 포함
- PDFPageWithTextLayer 컴포넌트 (pdfjs로 페이지 렌더 + 좌표 기반 텍스트 span 오버레이)
- 원문 키워드 검색 뷰어에서 elements fetch 후 PDFPageWithTextLayer 사용

### revert 사유
동작이 기대대로 되지 않아 전면 revert. **내일 다시 시도 예정.**

---

## 8. 요약

| 항목 | 내용 |
|------|------|
| 통합 분석 | 선택 문서에 해당하는 증거기록 분류·분석 참고 |
| 페이지 번호 | 문서 분석도 _pages.json 기반 페이지 표기 사용 |
| 업로드 | 텍스트(기본) 선택 시에도 txtFileUrl 기준 저장으로 정상 동작 |
| 증거기록 분류 | 문서별 분류 삭제 API 및 UI 추가 |
| 분석 상세 PDF | 페이지 참조 클릭 시 오른쪽 고정 뷰어, 페이지 이동·확대 |
| OCR | 좌표 포함(coordinates) 옵션 추가 (텍스트 레이어 기반) |
| 텍스트 레이어 | 시도 후 revert, 내일 재시도 예정 |
