# 진행 내역 (2026-02-21)

## 1. 참고자료 RAG 고도화

### 1.1 정리 문서
- **docs/RAG_TECHNIQUES_AND_IMPLEMENTATION.md** 추가: 2025~2026 RAG 기법 정리(Anthropic Contextual Retrieval, Late Chunking, Semantic Chunking, Hybrid Search 등), 현재 구현 진단, ASSO 채택 전략 및 구현 상세.

### 1.2 Contextual Chunking (맥락 붙이기)
- **lib/contextualChunk.js**: `getChunkContext`, `getChunkContexts` — 문서 제목·전체 텍스트 일부·청크를 Gemini Flash에 넘겨 맥락 문장 생성.
- **참고자료 ingest**: 청킹 직후, 저장 전에 청크별 맥락 생성 → `content = "[맥락] ... \n\n" + 본문` 형태로 저장·임베딩. FormData `skipContextualize=true` 시 생략.

### 1.3 Hybrid Search (벡터 + 전문 검색)
- **docs/REFERENCE_RAG_TABLES_SETUP.md** §6: `reference_chunks.content_tsv`(tsvector), 트리거, RPC `match_reference_chunks_hybrid`(RRF 병합) SQL 추가.
- **lib/referenceChunks.js**: `searchReferenceChunksHybrid(queryText, matchCount)` 추가. RPC 없으면 벡터 검색만 사용.
- **POST /api/opinion/reference-preview**: `searchReferenceChunksHybrid` 사용.

### 1.4 섹션 청킹 보강
- **lib/chunkText.js**: `chunkBySections`의 `sectionStartRe`에 제○조·제○항, ① ② ③, (가)(나), 1) 2) 등 법률 문서 패턴 추가.

---

## 2. pdfjs CMap 경고 수정

- **증상**: `loadFont - translateFont failed: ... Adobe-Korea1-UCS2.bcmap` (unpkg 경로).
- **조치**: **lib/pdfNativeExtract.js**의 `cMapUrl`을 설치 버전·경로에 맞게 `https://unpkg.com/pdfjs-dist@5.4.624/files/cmaps/`로 변경.

---

## 3. 문서 업로드 — 디지털 원본 / 스캔본 구분

- **배경**: 디지털 원본 PDF까지 OCR하면 비용·시간 낭비. 참고자료처럼 구분 적용.
- **API**: **POST /api/extract-pdf-text** 추가 — PDF 파일 받아 pdfjs로 텍스트만 추출, txt·_pages.json 스토리지 저장, 응답 형식은 OCR과 동일.
- **사건 페이지 (app/cases/[id]/page.js)**:
  - 상태 `pdfSourceType`: `'scanned'`(기본) | `'digital'`.
  - UI: PDF 유형 선택 — 「스캔본(이미지) — OCR 사용」 / 「디지털 원본 — OCR 없이 텍스트만 추출」. 스캔본일 때만 OCR 출력 형식·좌표 포함 옵션 표시.
  - 업로드 시: 디지털이면 `/api/extract-pdf-text`, 스캔이면 `/api/ocr` 호출 후 동일하게 문서 저장·청킹.

---

## 4. 엔티티 분석 (인물·장소·관계)

- **목적**: 수사기록에 등장하는 인물·장소·증거물을 자동 추출하고, 인물 간 관계를 정리해 한눈에 파악.
- **API**: **POST /api/analyze-entities** — 요청: analysisId, texts, documentIds, analysis, userContext. 기존 분석 요약·쟁점 + 수사기록 원문을 Gemini 2.5 Flash에 넘겨 persons/locations/relationships/evidence_items JSON 추출. 추출 결과를 해당 분석의 result에 병합해 저장(updateAnalysisResult).
- **추출 스키마**: persons( name, aliases, role, description, key_statements, credibility_notes, pages ), locations( name, type, related_events, pages ), relationships( person1, person2, type, description, evidence_pages ), evidence_items( name, type, description, relevance, related_persons, pages ).
- **UI (app/cases/[id]/page.js)**:
  - 분석 상세 상단에 「엔티티 분석」 버튼. 클릭 시 runEntityAnalysis: 선택 분석의 document_ids로 문서 텍스트 구성 → /api/analyze-entities 호출 → loadCase 후 해당 분석에 entities 표시.
  - 블록 「엔티티 분석 (인물·장소·관계)」: result.entities 있으면 인물(역할 배지·별칭·핵심 진술·p.N 링크)·관계 테이블·장소 목록·증거물 목록 표시; 없으면 「엔티티 분석 실행」 버튼만 표시.

---

## 5. 보류 목록 정리

- **FEATURES.md** 보류/미구현에 추가: **혼합 PDF 페이지 단위 처리** — 텍스트 레이어 있는 페이지는 pdfjs만, 없는 페이지만 이미지로 렌더 후 OCR해 비용 절감. 문서 업로드·참고자료 ingest 적용 예정. (나중에 구현)

---

## 6. 요약

| 항목 | 내용 |
|------|------|
| RAG 고도화 | Contextual Chunking, Hybrid Search, 섹션 청킹 보강, 정리 문서 |
| pdfjs | CMap URL 5.4.624/files/cmaps 로 수정 |
| 문서 업로드 | 디지털 원본 선택 시 OCR 생략, extract-pdf-text API |
| 엔티티 분석 | POST /api/analyze-entities, 인물·장소·관계·증거물 추출 및 UI |
| 백로그 | 혼합 PDF 페이지 단위 처리 → FEATURES.md 보류 목록 |
